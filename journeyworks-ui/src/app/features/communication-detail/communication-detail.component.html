<div class="communication-detail">
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="48"></mat-spinner>
    </div>
  } @else {
    @if (communication(); as comm) {
      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <a routerLink="/communications">Communications</a>
        <mat-icon>chevron_right</mat-icon>
        <span>{{ comm.subject || "Communication Detail" }}</span>
      </div>

      <!-- Header Bar -->
      <div class="header-bar">
        <div class="header-left">
          <mat-icon class="channel-icon">{{
            getChannelIcon(comm.channel)
          }}</mat-icon>
          <div class="header-text">
            <h1>{{ comm.subject || "(No subject)" }}</h1>
            <div class="meta">
              <span
                >From:
                <a
                  [routerLink]="['/customers', comm.customerId]"
                  class="customer-link"
                  >{{ comm.customerName }}</a
                >
              </span>
              <span class="divider">•</span>
              <span>{{ comm.timestamp | date: "medium" }}</span>
              <span class="divider">•</span>
              <span>{{ comm.direction | titlecase }}</span>
            </div>
          </div>
        </div>
        <div class="header-right">
          <span class="status-badge" [ngClass]="getStatusClass(comm.status)">
            {{ comm.status.replace("_", " ") | titlecase }}
          </span>
          <button mat-icon-button [matMenuTriggerFor]="statusMenu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #statusMenu="matMenu">
            <button mat-menu-item (click)="updateStatus('open')">Open</button>
            <button mat-menu-item (click)="updateStatus('in_progress')">
              In Progress
            </button>
            <button mat-menu-item (click)="updateStatus('resolved')">
              Resolved
            </button>
            <button mat-menu-item (click)="updateStatus('escalated')">
              Escalated
            </button>
          </mat-menu>
        </div>
      </div>

      <div class="detail-layout">
        <!-- Main Content -->
        <div class="main-content">
          <div class="section-card">
            <div class="section-header">Message Content</div>
            <div class="message-content">{{ comm.content }}</div>
          </div>

          <!-- Message Thread -->
          @if (comm.messages?.length) {
            <div class="section-card">
              <div class="section-header">
                Message Thread ({{ comm.messages!.length }})
              </div>
              <div class="thread-messages">
                @for (msg of comm.messages!; track msg.id) {
                  <div
                    class="thread-message"
                    [class.customer]="msg.sender === 'customer'"
                    [class.agent]="msg.sender === 'agent'"
                    [class.system]="msg.sender === 'system'"
                  >
                    <div class="message-header">
                      <span class="sender">{{ msg.sender | titlecase }}</span>
                      <span class="timestamp">{{
                        msg.timestamp | date: "short"
                      }}</span>
                    </div>
                    <div class="message-body">{{ msg.content }}</div>
                    @if (msg.sentiment !== undefined) {
                      <div
                        class="message-sentiment"
                        [class.negative]="msg.sentiment < -0.3"
                        [class.positive]="msg.sentiment > 0.3"
                      >
                        Sentiment: {{ msg.sentiment | number: "1.2-2" }}
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
          <!-- Details -->
          <div class="sidebar-card">
            <div class="sidebar-title">Details</div>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="label">Priority</span>
                <span
                  class="priority-badge"
                  [ngClass]="'priority-' + comm.priority"
                  >{{ comm.priority | titlecase }}</span
                >
              </div>
              <div class="detail-item">
                <span class="label">Channel</span>
                <span class="value">{{ comm.channel | titlecase }}</span>
              </div>
              <div class="detail-item">
                <span class="label">Assigned To</span>
                <span class="value">{{ comm.assignedTo || "Unassigned" }}</span>
              </div>
              @if (comm.caseId) {
                <div class="detail-item">
                  <span class="label">Case ID</span>
                  <span class="value case-link">{{ comm.caseId }}</span>
                </div>
              }
            </div>
          </div>

          <!-- Sentiment -->
          <div class="sidebar-card">
            <div class="sidebar-title">Sentiment</div>
            @if (comm.sentiment) {
              <div
                class="sentiment-display"
                [ngClass]="getSentimentClass(comm.sentiment)"
              >
                <div class="sentiment-score">
                  {{ comm.sentiment.score * 100 | number: "1.0-0" }}
                </div>
                <div class="sentiment-meta">
                  <span class="sentiment-label">{{
                    comm.sentiment.label | titlecase
                  }}</span>
                  <span class="sentiment-confidence"
                    >{{ comm.sentiment.confidence * 100 | number: "1.0-0" }}%
                    confidence</span
                  >
                </div>
              </div>
            } @else {
              <p class="no-data">No sentiment data</p>
            }
          </div>

          <!-- Tags -->
          <div class="sidebar-card">
            <div class="sidebar-title">Tags</div>
            @if (comm.tags?.length) {
              <div class="tags-list">
                @for (tag of comm.tags; track tag) {
                  <span class="tag-chip">{{ tag }}</span>
                }
              </div>
            } @else {
              <p class="no-data">No tags</p>
            }
          </div>

          <!-- AI Classification -->
          @if (comm.aiClassification) {
            <div class="sidebar-card ai-card">
              <div class="sidebar-title">
                <mat-icon class="ai-icon">psychology</mat-icon> AI
                Classification
              </div>
              <div class="detail-grid">
                <div class="detail-item">
                  <span class="label">Category</span>
                  <span class="value">{{
                    comm.aiClassification.category.replace("-", " ") | titlecase
                  }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Product</span>
                  <span class="value">{{
                    comm.aiClassification.product.replace("-", " ") | titlecase
                  }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Issue Type</span>
                  <span class="value">{{
                    comm.aiClassification.issueType
                  }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Urgency</span>
                  <span
                    class="value"
                    [ngClass]="'urgency-' + comm.aiClassification.urgency"
                    >{{ comm.aiClassification.urgency | titlecase }}</span
                  >
                </div>
                <div class="detail-item">
                  <span class="label">Confidence</span>
                  <span class="value"
                    >{{
                      comm.aiClassification.confidence * 100 | number: "1.0-0"
                    }}%</span
                  >
                </div>
              </div>
              @if (comm.aiClassification.rootCause) {
                <div class="ai-insight">
                  <span class="label">Root Cause</span>
                  <p>{{ comm.aiClassification.rootCause }}</p>
                </div>
              }
              @if (comm.aiClassification.suggestedAction) {
                <div class="ai-insight suggested">
                  <span class="label">Suggested Action</span>
                  <p>{{ comm.aiClassification.suggestedAction }}</p>
                </div>
              }
              @if (comm.aiClassification.regulatoryFlags.length) {
                <div class="ai-insight">
                  <span class="label">Regulatory Flags</span>
                  <div class="tags-list">
                    @for (
                      flag of comm.aiClassification.regulatoryFlags;
                      track flag
                    ) {
                      <span class="tag-chip warn">{{ flag }}</span>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    } @else {
      <div class="error-state">
        <mat-icon>error_outline</mat-icon>
        <h2>Communication Not Found</h2>
        <p>
          {{ error() || "The requested communication could not be loaded." }}
        </p>
        <a mat-raised-button routerLink="/communications"
          >Back to Communications</a
        >
      </div>
    }
  }
</div>
