<div class="research-panel-container">
  <!-- Header (Fixed) -->
  <div class="panel-header">
    <div class="header-title">
      <mat-icon>psychology</mat-icon>
      <h2>AI Research</h2>
    </div>
    @if (context()?.signal) {
      <mat-chip class="context-chip">
        {{ context()!.signal }}
      </mat-chip>
    }
  </div>

  <!-- Scrollable Content Area -->
  <div class="scrollable-content">
    @if (isLoading()) {
      <div class="loading-state">
        <mat-spinner diameter="32"></mat-spinner>
        <span>Analysing selection...</span>
      </div>
    }

    <!-- Empty State - shown before user selects anything -->
    @if (!insight() && !isLoading()) {
      <div class="empty-state">
        <div class="empty-icon">
          <mat-icon>touch_app</mat-icon>
        </div>
        <h3>Select to Analyze</h3>
        <p class="empty-description">
          Interact with the charts to begin AI-powered research and analysis.
        </p>

        <div class="hint-cards">
          <div class="hint-card">
            <mat-icon>timeline</mat-icon>
            <span
              >Click an <strong>event marker</strong> for incident
              analysis</span
            >
          </div>
          <div class="hint-card">
            <mat-icon>crop_free</mat-icon>
            <span
              >Drag to <strong>brush a time range</strong> for period
              insights</span
            >
          </div>
          <div class="hint-card">
            <mat-icon>bubble_chart</mat-icon>
            <span
              >Click a <strong>bubble or quadrant</strong> for issue
              deep-dive</span
            >
          </div>
          <div class="hint-card">
            <mat-icon>waterfall_chart</mat-icon>
            <span
              >Click a <strong>journey stage</strong> for process analysis</span
            >
          </div>
        </div>
      </div>
    }

    @if (insight() && !isLoading()) {
      <!-- Research Summary -->
      <section class="summary-section">
        <div class="summary-header">
          <h3>Summary</h3>
          <mat-chip
            [ngClass]="getConfidenceClass(insight()!.confidence)"
            class="confidence-chip"
          >
            {{ insight()!.confidence | titlecase }} Confidence
          </mat-chip>
        </div>
        <p class="summary-text">{{ insight()!.summary }}</p>
      </section>

      <!-- Charts Section -->
      @if (insight()?.charts?.length) {
        <section class="charts-section">
          <h3>Supporting Data</h3>
          @for (chart of insight()!.charts!; track chart.title) {
            <app-insight-chart-card [chart]="chart" />
          }
        </section>
      }

      <mat-divider></mat-divider>

      <!-- Key Drivers -->
      <section class="drivers-section">
        <h3>Key Drivers</h3>
        <ul class="drivers-list">
          @for (driver of insight()!.keyDrivers; track $index) {
            <li>
              <mat-icon>arrow_right</mat-icon>
              <span>{{ driver }}</span>
            </li>
          }
        </ul>
      </section>

      <!-- Follow-Up Question -->
      @if (insight()!.suggestedFollowUp) {
        <mat-divider></mat-divider>
        <mat-expansion-panel class="followup-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>help_outline</mat-icon>
              {{ insight()!.suggestedFollowUp!.question }}
            </mat-panel-title>
          </mat-expansion-panel-header>
          <div class="followup-answer">
            {{ insight()!.suggestedFollowUp!.answer }}
          </div>
        </mat-expansion-panel>
      }

      <mat-divider></mat-divider>

      <!-- Evidence (Expandable) -->
      <mat-expansion-panel class="evidence-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>source</mat-icon>
            @if (
              insight()!.totalCommunications &&
              insight()!.totalCommunications! > insight()!.evidence.length
            ) {
              Evidence ({{ insight()!.evidence.length }} of
              {{ insight()!.totalCommunications }})
            } @else {
              Evidence ({{ insight()!.evidence.length }})
            }
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="evidence-list">
          @for (item of insight()!.evidence; track item.id) {
            <div
              class="evidence-item"
              (click)="onEvidenceClick(item)"
              [class.clickable]="item.linkedChartId"
            >
              <div class="evidence-header">
                <mat-icon>{{ getEvidenceIcon(item.type) }}</mat-icon>
                <span class="evidence-source">{{ item.source }}</span>
                <span class="evidence-time">{{
                  formatDate(item.timestamp)
                }}</span>
              </div>
              <p class="evidence-excerpt">"{{ item.excerpt }}"</p>
              <div class="evidence-meta">
                <span
                  class="sentiment-badge"
                  [ngClass]="
                    item.sentiment < -0.4
                      ? 'negative'
                      : item.sentiment < 0
                        ? 'warning'
                        : 'positive'
                  "
                >
                  {{ item.sentiment | number: "1.2-2" }}
                </span>
                @if (item.linkedChartId) {
                  <span class="link-indicator">
                    <mat-icon>link</mat-icon>
                  </span>
                }
              </div>
            </div>
          }
        </div>
      </mat-expansion-panel>

      <!-- Agent Reasoning Steps -->
      @if (insight()!.reasoningSteps?.length) {
        <mat-divider></mat-divider>
        <mat-expansion-panel class="reasoning-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>psychology</mat-icon>
              Agent Reasoning ({{ insight()!.reasoningSteps!.length }} steps)
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="agent-reasoning-steps">
            @for (
              step of insight()!.reasoningSteps!;
              track step.step;
              let i = $index
            ) {
              <div class="reasoning-step">
                <div class="step-marker">
                  <mat-icon class="step-complete">check_circle</mat-icon>
                  @if (i < insight()!.reasoningSteps!.length - 1) {
                    <div class="step-line"></div>
                  }
                </div>
                <div class="step-body">
                  <div class="step-header">
                    <span class="step-number">Step {{ step.step }}</span>
                    <span class="step-action">{{ step.action }}</span>
                  </div>
                  <div class="step-thought">{{ step.thought }}</div>
                  @if (step.observation) {
                    <div class="step-observation">
                      <mat-icon>check_circle_outline</mat-icon>
                      <span>{{ step.observation }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </mat-expansion-panel>
      }

      <!-- Live Reasoning (shown during chat queries via WebSocket) -->
      @if (isStreamingReasoning() && liveReasoningSteps().length > 0) {
        <mat-expansion-panel class="reasoning-panel" [expanded]="true">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>psychology</mat-icon>
              Agent Reasoning
              <span class="live-badge">
                <mat-icon>sensors</mat-icon>
                Live
              </span>
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="agent-reasoning-steps live">
            @if (currentThinkingState(); as thinking) {
              <mat-progress-bar
                mode="indeterminate"
                class="thinking-progress"
              ></mat-progress-bar>
            }

            @for (
              step of liveReasoningSteps();
              track step.step;
              let i = $index
            ) {
              <div class="reasoning-step" [class]="getStepStatusClass(step)">
                <div class="step-marker">
                  <mat-icon [class]="getStepStatusClass(step)">
                    {{ getStepIcon(step) }}
                  </mat-icon>
                  @if (
                    i < liveReasoningSteps().length - 1 ||
                    isStreamingReasoning()
                  ) {
                    <div class="step-line"></div>
                  }
                </div>
                <div class="step-body">
                  <div class="step-header">
                    <span class="step-number">Step {{ step.step }}</span>
                    @if (step.action) {
                      <span class="step-action">{{ step.action }}</span>
                    }
                    @if (step.toolDuration) {
                      <span class="step-duration"
                        >{{ step.toolDuration }}ms</span
                      >
                    }
                  </div>
                  <div class="step-thought">{{ step.thought }}</div>
                  @if (
                    step.status === "tool-running" && currentToolCall();
                    as tool
                  ) {
                    <div class="tool-executing">
                      <mat-progress-spinner
                        diameter="16"
                        mode="indeterminate"
                      ></mat-progress-spinner>
                      <span>Running {{ tool.tool | titlecase }}...</span>
                    </div>
                  }
                  @if (step.observation) {
                    <div
                      class="step-observation"
                      [class.error]="step.toolSuccess === false"
                    >
                      <mat-icon>{{
                        step.toolSuccess === false
                          ? "error_outline"
                          : "check_circle_outline"
                      }}</mat-icon>
                      <span>{{ step.observation }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </mat-expansion-panel>
      }

      <!-- Suggested Actions -->
      <section class="actions-section">
        <h3>Suggested Actions</h3>
        <div class="action-chips">
          @for (action of insight()!.suggestedActions; track $index) {
            <mat-chip class="action-chip" [matTooltip]="action">
              <mat-icon>lightbulb</mat-icon>
              {{ action }}
            </mat-chip>
          }
        </div>
      </section>
    }
  </div>

  <!-- Chat Section (Fixed at Bottom) -->
  <div
    class="chat-section"
    [class.expanded]="isChatExpanded()"
    [class.resizing]="isResizing()"
    [style.height.px]="chatHeight()"
    #chatSectionEl
  >
    <!-- Resize Handle -->
    <div
      class="resize-handle"
      (mousedown)="onResizeStart($event)"
      matTooltip="Drag to resize"
    >
      <div class="handle-bar"></div>
    </div>

    <!-- Chat Header with Expand Toggle -->
    <div class="chat-header">
      <span class="chat-title">
        <mat-icon>chat</mat-icon>
        Chat
        @if (chatHistory().length > 0) {
          <span class="message-count">({{ chatHistory().length }})</span>
        }
      </span>
      <div class="chat-header-actions">
        <button
          mat-icon-button
          class="expand-btn"
          (click)="toggleChatExpanded()"
          [matTooltip]="isChatExpanded() ? 'Collapse chat' : 'Expand chat'"
        >
          <mat-icon>{{
            isChatExpanded() ? "expand_more" : "expand_less"
          }}</mat-icon>
        </button>
        <button
          mat-icon-button
          class="open-full-btn"
          (click)="openFullResearchPage()"
          matTooltip="Open full research page"
        >
          <mat-icon>open_in_new</mat-icon>
        </button>
      </div>
    </div>

    <!-- Suggested Questions -->
    <div class="suggested-questions">
      <span class="suggestion-label">Suggested:</span>
      @for (question of suggestedQuestions(); track $index) {
        <button
          class="suggestion-chip"
          [matTooltip]="question"
          (click)="onSuggestedQuestionClick(question)"
        >
          {{ question }}
        </button>
      }
    </div>

    <div class="chat-history" #chatHistoryContainer>
      @for (msg of chatHistory(); track $index) {
        <div class="chat-message" [ngClass]="msg.role">
          <div class="message-avatar">
            <mat-icon>{{
              msg.role === "user" ? "person" : "psychology"
            }}</mat-icon>
          </div>
          <div class="message-body">
            <!-- Reasoning Summary (for completed AI responses) -->
            @if (msg.role === "ai" && msg.reasoningSteps?.length) {
              <app-reasoning-summary
                [steps]="msg.reasoningSteps!"
                [streaming]="false"
              />
            }
            <div
              class="message-content"
              [innerHTML]="msg.message | markdown"
            ></div>
          </div>
        </div>
      }

      <!-- Live Reasoning + Typing Indicator (during streaming) -->
      @if (isTyping()) {
        <div class="chat-message ai typing">
          <div class="message-avatar">
            <mat-icon>psychology</mat-icon>
          </div>
          <div class="message-body">
            <div
              class="message-content typing-toggle"
              (click)="showLiveReasoning.set(!showLiveReasoning())"
              [matTooltip]="
                showLiveReasoning() ? 'Hide reasoning' : 'Show reasoning'
              "
            >
              <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
              </div>
              @if (isStreamingReasoning() && liveReasoningSteps().length > 0) {
                <mat-icon
                  class="reasoning-peek-icon"
                  [class.active]="showLiveReasoning()"
                >
                  {{ showLiveReasoning() ? "visibility_off" : "auto_awesome" }}
                </mat-icon>
              }
            </div>
            <!-- Live Reasoning Summary (toggled by clicking dots) -->
            @if (
              showLiveReasoning() &&
              isStreamingReasoning() &&
              liveReasoningSteps().length > 0
            ) {
              <app-reasoning-summary
                [liveSteps]="liveReasoningSteps()"
                [streaming]="true"
                [streamStatus]="streamStatus()"
              />
            }
          </div>
        </div>
      }
    </div>

    <div class="chat-input-row">
      <mat-form-field appearance="outline" class="chat-field">
        <mat-label>Ask a follow-up question...</mat-label>
        <input
          matInput
          [(ngModel)]="chatInput"
          (keyup.enter)="onChatSubmit()"
          placeholder="e.g., Why did social sentiment lead complaints?"
        />
      </mat-form-field>
      <button
        mat-icon-button
        color="primary"
        (click)="onChatSubmit()"
        [disabled]="!chatInput.trim()"
      >
        <mat-icon>send</mat-icon>
      </button>
    </div>
  </div>
</div>
