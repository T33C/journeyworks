<div class="research-page">
  <div class="research-container">
    <!-- Chat Area -->
    <div class="chat-area">
      <div class="chat-header">
        <div class="header-title">
          <mat-icon>psychology</mat-icon>
          <h1>AI Research Assistant</h1>
          @if (currentContext()) {
            <span
              class="context-badge"
              matTooltip="Conversation context from dashboard"
            >
              <mat-icon>link</mat-icon>
              Dashboard Context
            </span>
          }
        </div>
        <div class="header-actions">
          @if (!isApiAvailable()) {
            <span class="api-status offline" matTooltip="API connection lost">
              <mat-icon>cloud_off</mat-icon>
            </span>
          }
          <button
            mat-icon-button
            (click)="toggleReasoning()"
            [matTooltip]="showReasoning ? 'Hide reasoning' : 'Show reasoning'"
          >
            <mat-icon>auto_awesome</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="clearConversation()"
            matTooltip="New conversation"
          >
            <mat-icon>refresh</mat-icon>
          </button>
        </div>
      </div>

      <!-- Messages -->
      <div class="messages-container" #messagesContainer>
        @if (messages().length === 0) {
          <div class="welcome-state">
            <div class="welcome-icon">
              <mat-icon>psychology_alt</mat-icon>
            </div>
            <h2>Ask me anything about your customer data</h2>
            <p>
              I can help you analyze communications, identify trends, find
              at-risk customers, and more. Powered by the ReAct agent with
              access to your real data.
            </p>

            <div class="suggestion-chips">
              @for (suggestion of suggestions(); track suggestion) {
                <button (click)="useSuggestion(suggestion)">
                  {{ suggestion }}
                </button>
              }
            </div>
          </div>
        } @else {
          <!-- Show a context banner if conversation came from dashboard -->
          @if (currentContext() && messages().length > 0) {
            <div class="context-banner">
              <mat-icon>info_outline</mat-icon>
              <span>Conversation continued from dashboard analysis</span>
            </div>
          }
          @for (message of messages(); track message.id) {
            <div class="message" [class]="'message-' + message.role">
              <div class="message-avatar">
                <mat-icon>{{
                  message.role === "user" ? "person" : "auto_awesome"
                }}</mat-icon>
              </div>
              <div class="message-content">
                <div
                  class="message-text"
                  [innerHTML]="message.content | markdown"
                ></div>

                @if (message.charts?.length) {
                  <div class="message-charts">
                    @for (chart of message.charts; track chart.title) {
                      <app-insight-chart-card [chart]="chart" />
                    }
                  </div>
                }

                @if (message.sources?.length) {
                  <div class="message-sources">
                    <span class="sources-label">Sources:</span>
                    @for (source of message.sources; track source.id) {
                      <mat-chip
                        [matTooltip]="source.snippet"
                        (click)="openSourceDetail(source)"
                        class="clickable-source"
                      >
                        <mat-icon>{{ getSourceIcon(source.type) }}</mat-icon>
                        {{ source.title }}
                      </mat-chip>
                    }
                  </div>
                }

                <span class="message-time">{{
                  message.timestamp | date: "shortTime"
                }}</span>
              </div>
            </div>
          }

          @if (isLoading()) {
            <div class="message message-assistant">
              <div class="message-avatar">
                <mat-icon>auto_awesome</mat-icon>
              </div>
              <div class="message-content">
                <div class="thinking-indicator">
                  <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                  <span>{{
                    isStreaming() ? streamStatus() : currentThinking
                  }}</span>
                </div>
                @if (isStreaming()) {
                  <button
                    mat-button
                    class="cancel-btn"
                    (click)="cancelResearch()"
                  >
                    <mat-icon>stop</mat-icon>
                    Cancel
                  </button>
                }
              </div>
            </div>
          }
        }
      </div>

      <!-- Input Area -->
      <div class="input-area">
        @if (
          messages().length > 0 && suggestions().length > 0 && !isLoading()
        ) {
          <div class="follow-up-suggestions">
            <span class="suggestions-label">Suggested:</span>
            @for (suggestion of suggestions(); track suggestion) {
              <button
                (click)="useSuggestion(suggestion)"
                class="suggestion-btn"
              >
                {{ suggestion }}
              </button>
            }
          </div>
        }

        <div class="input-row">
          <mat-form-field appearance="outline" class="query-input">
            <input
              matInput
              [(ngModel)]="currentQuery"
              (keyup.enter)="sendQuery()"
              placeholder="Ask a question about your customer data..."
              [disabled]="isLoading()"
              #queryInput
            />
          </mat-form-field>
          <button
            mat-fab
            (click)="sendQuery()"
            [disabled]="!currentQuery.trim() || isLoading()"
          >
            <mat-icon>send</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Reasoning Panel -->
    @if (showReasoning) {
      <div class="reasoning-panel">
        <div class="reasoning-header">
          <h3><mat-icon>psychology</mat-icon> Agent Reasoning</h3>
          @if (wsConnected()) {
            <span
              class="ws-status connected"
              matTooltip="Live streaming enabled"
            >
              <mat-icon>sensors</mat-icon>
              Live
            </span>
          } @else {
            <span
              class="ws-status disconnected"
              matTooltip="WebSocket disconnected - using HTTP fallback"
            >
              <mat-icon>sensors_off</mat-icon>
            </span>
          }
        </div>

        <!-- Live streaming timeline (shown during active research) -->
        @if (isStreaming() && liveReasoningSteps().length > 0) {
          <div class="live-reasoning-timeline">
            @if (currentThinkingState(); as thinking) {
              <mat-progress-bar
                mode="indeterminate"
                class="thinking-progress"
              ></mat-progress-bar>
            }

            @for (
              step of liveReasoningSteps();
              track step.step;
              let i = $index
            ) {
              <div class="timeline-step" [class]="getStepStatusClass(step)">
                <div class="timeline-marker">
                  <mat-icon [class]="getStepStatusClass(step)">
                    {{ getStepIcon(step) }}
                  </mat-icon>
                  @if (i < liveReasoningSteps().length - 1 || isStreaming()) {
                    <div class="timeline-line"></div>
                  }
                </div>
                <div class="timeline-content">
                  <div class="timeline-header">
                    <span class="step-number">Step {{ step.step }}</span>
                    @if (step.action) {
                      <span class="step-action">{{ step.action }}</span>
                    }
                    @if (step.toolDuration) {
                      <span class="step-duration"
                        >{{ step.toolDuration }}ms</span
                      >
                    }
                  </div>
                  <div class="step-thought-text">{{ step.thought }}</div>
                  @if (
                    step.status === "tool-running" && currentToolCall();
                    as tool
                  ) {
                    <div class="tool-executing">
                      <mat-progress-spinner
                        diameter="16"
                        mode="indeterminate"
                      ></mat-progress-spinner>
                      <span>Running {{ tool.tool | titlecase }}...</span>
                    </div>
                  }
                  @if (step.observation) {
                    <div
                      class="step-observation-text"
                      [class.error]="step.toolSuccess === false"
                    >
                      <mat-icon>{{
                        step.toolSuccess === false
                          ? "error_outline"
                          : "check_circle_outline"
                      }}</mat-icon>
                      <span>{{ step.observation }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }

        <!-- Static reasoning steps (shown after research completes) -->
        @if (!isStreaming() && lastReasoningSteps().length > 0) {
          <div class="reasoning-steps">
            @for (step of lastReasoningSteps(); track step.step) {
              <mat-expansion-panel>
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <mat-icon class="step-complete">check_circle</mat-icon>
                    Step {{ step.step }}: {{ step.action }}
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <div class="step-content">
                  <div class="step-thought">
                    {{ step.thought }}
                  </div>
                  @if (step.observation) {
                    <div class="step-observation">
                      <strong>Result:</strong> {{ step.observation }}
                    </div>
                  }
                </div>
              </mat-expansion-panel>
            }
          </div>
        }

        <!-- Empty state for reasoning panel -->
        @if (
          !isStreaming() &&
          lastReasoningSteps().length === 0 &&
          liveReasoningSteps().length === 0
        ) {
          <div class="reasoning-empty">
            <mat-icon>psychology_alt</mat-icon>
            <p>
              Submit a question to see the agent's reasoning process in
              real-time.
            </p>
          </div>
        }

        @if (lastSources().length > 0) {
          <h3><mat-icon>source</mat-icon> Sources Used</h3>
          <div class="sources-list">
            @for (source of lastSources(); track source.id) {
              <div
                class="source-item clickable-source"
                (click)="openSourceDetail(source)"
              >
                <mat-icon>{{ getSourceIcon(source.type) }}</mat-icon>
                <div class="source-info">
                  <span class="source-title">{{ source.title }}</span>
                  <span class="source-snippet">{{ source.snippet }}</span>
                  <span class="source-score"
                    >{{ source.relevanceScore * 100 | number: "1.0-0" }}%
                    match</span
                  >
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>
</div>
